#!/bin/sh
#
# APFS Fusion Diagnostics
#
# Collect information about the running system to help with diagnosing
# APFS Fusion issues
#

cat <<EOF
This tool generates files that permit Apple to investigate issues with
the disk and storage configuration of your device and to help improve
related Apple products. The diagnostic files generated by this tool may
contain personal information found on your device that is related to
your disk and storage configuration, including but not limited to,
encrypted volume keys, confirmation hashes, the number and types of
disks attached to your system, volume names, identifiers and sizes,
and user names, contact card photos and password hints.

This information is used by Apple in accordance with its privacy policy
and is not shared with any other company. By using this tool and sending
the results to Apple, you consent to Apple using the contents of these
files to improve related Apple products.

This tool must run with superuser privileges, please enter your password
to unlock this functionality
EOF

if ! sudo id -un > /dev/null ; then
	echo Cannot switch to superuser, exiting without collecting the information
	exit 1
fi


PATH=/bin:/sbin/:/usr/bin:/usr/sbin

stagedir=`mktemp -d -t diagnose-fu`

if [ ! -d "$stagedir" ] ; then
	echo Cannot create temporary directory
	exit 2
fi

trap "rm -rf $stagedir; exit" 0 1 2 3 15

for difutool in sw_vers mount "df -lh" kextstat "diskutil list" "diskutil apfs list"
do
	$difutool > "$stagedir/$difutool.txt"
done

# Collect information about apfs.kext
kextfind -bundle-name -substring apfs | while read kext; do
	kextdir="$stagedir/`basename $kext`"
	mkdir "$kextdir" || exit 1
	for p in Info.plist version.plist; do
		if [ -f "$kext/Contents/$p" ] ; then
			cp "$kext/Contents/$p" "$kextdir/$p" || exit 1
		fi
	done
done

apfsfs=/System/Library/Filesystems/apfs.fs
if [ -d $apfsfs ] ; then
	mkdir "$stagedir/apfs.fs" || exit 1
	for p in Info.plist version.plist; do
		f=$apfsfs/Contents/$p
		if [ -f $f ] ; then
			cp $f "$stagedir/apfs.fs/$p"
		fi
	done

	# Collect performance counters
	if [ -x $apfsfs/Contents/Resources/apfs_stats ] ; then
		$apfsfs/Contents/Resources/apfs_stats > "$stagedir/apfs_stats.txt"
	fi
fi

parentdir=`dirname "$stagedir"`
(cd $parentdir; tar cjf $stagedir.tar.bz2 `basename "$stagedir"`) || exit 1
echo Diagnostic information is saved in $stagedir.tar.bz2
exit 0
